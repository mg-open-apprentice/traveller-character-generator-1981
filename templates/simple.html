<!DOCTYPE html>
<html>
<head>
    <title>Traveller Character Generator</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        
        h1 { text-align: center; margin-bottom: 30px; }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            height: 80vh;
        }
        
        .sidebar {
            background-color: #2a2a2a;
            border: 2px solid #00ff00;
            padding: 20px;
            display: flex;
            flex-direction: column; /* Make the sidebar a flex container */
        }
        
        .sidebar-top {
            flex-grow: 1; /* Take up available space */
        }
        
        .sidebar-bottom {
            margin-top: 20px; /* Space above the bottom section */
        }
        
        .main-panel {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
        }
        
        .character-panel, .messages-panel {
            background-color: #2a2a2a;
            border: 2px solid #00ff00;
            padding: 20px;
            overflow-y: auto;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid;
            background-color: transparent;
            color: inherit;
            cursor: pointer;
            font-family: inherit;
            font-size: 16px;
        }
        
        .btn-create {
            border-color: #00ff00;
            color: #00ff00;
        }
        
        .btn-create:hover:not(:disabled) {
            background-color: #003300;
        }
        
        .btn-delete {
            border-color: #ff4444;
            color: #ff4444;
        }
        
        .btn-delete:hover:not(:disabled) {
            background-color: #330000;
        }

        .btn-roll {
            border-color: #00ffff;
            color: #00ffff;
        }
        
        .btn-roll:hover:not(:disabled) {
            background-color: #003333;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #666;
            color: #666;
        }
        
        .char-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .char-item {
            background-color: #333;
            border: 1px solid #666;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .char-item.empty {
            background-color: #222;
            border: 1px dashed #444;
        }
        
        .char-item.highlight {
            border-color: #00ffff;
            background-color: #003333;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .char-label { 
            font-weight: bold; 
            margin-bottom: 8px; 
            color: #87ceeb;
            font-size: 14px;
        }
        .char-value { 
            font-size: 28px; 
            font-weight: bold; 
            color: #ffff00; 
            margin-bottom: 5px;
        }
        .char-hex { 
            font-size: 12px; 
            color: #999; 
            font-family: monospace;
        }
        
        .no-character {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .character-name {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .name {
            font-size: 28px;
            color: #ffff00;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .age {
            font-size: 16px;
            color: #87ceeb;
            margin-bottom: 10px;
        }
        
        .upp {
            font-size: 20px;
            color: #87ceeb;
            font-family: monospace;
            letter-spacing: 3px;
            font-weight: bold;
        }
        
        .messages-content {
            background-color: #000;
            padding: 15px;
            height: calc(100% - 60px);
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 5px;
        }
        
        h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ff00;
        }
        
        h3 {
            color: #00ff00;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-start {
            background-color: #004400;
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        
        .status-progress {
            background-color: #444400;
            border: 1px solid #ffff00;
            color: #ffff00;
        }
        
        .status-complete {
            background-color: #000044;
            border: 1px solid #87ceeb;
            color: #87ceeb;
        }

        .characteristics-buttons {
            margin-top: 20px;
            border-top: 1px solid #444;
            padding-top: 15px;
        }

        .characteristic-roll-title {
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ² TRAVELLER CHARACTER GENERATOR</h1>
    
    <div class="container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <!-- Top Section of Sidebar -->
            <div class="sidebar-top">
                <h2>CONTROLS</h2>
                
                <!-- Status Indicator -->
                {% if state == 'start' %}
                    <div class="status-indicator status-start">READY TO CREATE CHARACTER</div>
                {% elif state == 'in_progress' %}
                    <div class="status-indicator status-progress">CHARACTER IN PROGRESS</div>
                {% elif state == 'complete' %}
                    <div class="status-indicator status-complete">CHARACTER COMPLETE</div>
                {% endif %}
                
                <!-- Create Button - Only show when no character exists -->
                {% if state == 'start' %}
                <button id="create-btn" class="btn btn-create">
                    <div style="font-size: 18px;">CREATE CHARACTER</div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                        Generate random sci-fi name + characteristics
                    </div>
                </button>
                {% endif %}
                
                <div style="margin-top: 30px; padding: 15px; background-color: #333; border: 1px solid #666; border-radius: 5px;">
                    <h4 style="color: #ffff00; margin-top: 0;">Session State</h4>
                    <div style="font-size: 12px; color: #ccc; line-height: 1.4;">
                        â€¢ Create disappears when character exists<br>
                        â€¢ Delete only shows with character<br>
                        â€¢ Character persists in session<br>
                        â€¢ State: <strong>{{ state.upper() }}</strong>
                    </div>
                </div>
                
                <!-- Characteristic Roll Buttons - Only show when character exists -->
                {% if character %}
                <div class="characteristics-buttons">
                    <div class="characteristic-roll-title">ROLL CHARACTERISTICS</div>
                    
                    <!-- Show buttons only for characteristics that haven't been rolled yet -->
                    {% if not character.characteristics or 'str' not in character.characteristics %}
                    <button id="roll-str-btn" class="btn btn-roll" data-char="str">
                        <div style="font-size: 16px;">STRENGTH (STR)</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Roll 2d6</div>
                    </button>
                    {% endif %}
                    
                    {% if not character.characteristics or 'dex' not in character.characteristics %}
                    <button id="roll-dex-btn" class="btn btn-roll" data-char="dex">
                        <div style="font-size: 16px;">DEXTERITY (DEX)</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Roll 2d6</div>
                    </button>
                    {% endif %}
                    
                    {% if not character.characteristics or 'end' not in character.characteristics %}
                    <button id="roll-end-btn" class="btn btn-roll" data-char="end">
                        <div style="font-size: 16px;">ENDURANCE (END)</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Roll 2d6</div>
                    </button>
                    {% endif %}
                    
                    {% if not character.characteristics or 'int' not in character.characteristics %}
                    <button id="roll-int-btn" class="btn btn-roll" data-char="int">
                        <div style="font-size: 16px;">INTELLIGENCE (INT)</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Roll 2d6</div>
                    </button>
                    {% endif %}
                    
                    {% if not character.characteristics or 'edu' not in character.characteristics %}
                    <button id="roll-edu-btn" class="btn btn-roll" data-char="edu">
                        <div style="font-size: 16px;">EDUCATION (EDU)</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Roll 2d6</div>
                    </button>
                    {% endif %}
                    
                    {% if not character.characteristics or 'soc' not in character.characteristics %}
                    <button id="roll-soc-btn" class="btn btn-roll" data-char="soc">
                        <div style="font-size: 16px;">SOCIAL STANDING (SOC)</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Roll 2d6</div>
                    </button>
                    {% endif %}
                    
                    <!-- If all characteristics are rolled, show a message -->
                    {% if character.characteristics and 'str' in character.characteristics and 'dex' in character.characteristics and 'end' in character.characteristics and 'int' in character.characteristics and 'edu' in character.characteristics and 'soc' in character.characteristics %}
                    <div style="text-align: center; color: #00ffff; padding: 10px;">
                        All characteristics rolled!
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <!-- Bottom Section of Sidebar with Delete Button -->
            {% if character %}
            <div class="sidebar-bottom">
                <button id="delete-btn" class="btn btn-delete">
                    <div style="font-size: 18px;">DELETE CHARACTER</div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                        Reset and start over
                    </div>
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Right Panel -->
        <div class="main-panel">
            <!-- Top Right - Character Display -->
            <div class="character-panel">
                <h2>CHARACTER STATUS</h2>
                
                {% if character %}
                <div class="character-name">
                    <div class="name">{{ character.name }}</div>
                    <!-- Display age -->
                    <div class="age">Age: {{ character.age }}</div>
                    
                    <!-- Only show UPP if characteristics exist and have all required attributes -->
                    {% if character.characteristics and character.characteristics.get('str') is not none and 
                         character.characteristics.get('dex') is not none and 
                         character.characteristics.get('end') is not none and 
                         character.characteristics.get('int') is not none and 
                         character.characteristics.get('edu') is not none and 
                         character.characteristics.get('soc') is not none %}
                    <div class="upp">UPP: 
                        {% for stat in ['str', 'dex', 'end', 'int', 'edu', 'soc'] %}
                            {% set value = character.characteristics.get(stat) %}
                            {%- if value >= 10 and value <= 15 -%}
                                {{ '%X'|format(value) }}
                            {%- else -%}
                                {{ value }}
                            {%- endif -%}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div>
                    <h3>CHARACTERISTICS</h3>
                    <div class="char-grid">
                        {% set labels = ['STR', 'DEX', 'END', 'INT', 'EDU', 'SOC'] %}
                        {% set stats = ['str', 'dex', 'end', 'int', 'edu', 'soc'] %}
                        {% for i in range(6) %}
                        <div id="char-item-{{ stats[i] }}" class="char-item{% if not character.characteristics or stats[i] not in character.characteristics %} empty{% endif %}">
                            <div class="char-label">{{ labels[i] }}</div>
                            {% if character.characteristics and character.characteristics.get(stats[i]) is not none %}
                                {% set value = character.characteristics.get(stats[i]) %}
                                <div class="char-value">{{ value }}</div>
                                <div class="char-hex">
                                    ({% if value >= 10 and value <= 15 %}{{ '%X'|format(value) }}{% else %}{{ value }}{% endif %})
                                </div>
                            {% else %}
                                <div class="char-value" style="color: #444;">-</div>
                                <div class="char-hex">(Not rolled)</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                {% if state == 'in_progress' %}
                <div style="margin-top: 20px; padding: 15px; background-color: #444400; border: 1px solid #ffff00; border-radius: 5px;">
                    <h4 style="color: #ffff00; margin-top: 0;">Character In Progress</h4>
                    <div style="font-size: 12px; color: #ffff00;">
                        {% if character.characteristics and 'str' in character.characteristics and 'dex' in character.characteristics and 'end' in character.characteristics and 'int' in character.characteristics and 'edu' in character.characteristics and 'soc' in character.characteristics %}
                        Phase: Characteristics complete<br>
                        Next: Service selection
                        {% else %}
                        Phase: Characteristic generation<br>
                        Next: Roll remaining characteristics
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% else %}
                <div class="no-character">
                    <div style="font-size: 64px; margin-bottom: 20px;">ðŸŽ¯</div>
                    <div style="font-size: 20px; margin-bottom: 15px;">No Character Created</div>
                    <div style="font-size: 14px;">Click "CREATE CHARACTER" to begin character generation</div>
                </div>
                {% endif %}
            </div>

            <!-- Bottom Right - Messages Panel -->
            <div class="messages-panel">
                <h2>MESSAGES</h2>
                <div class="messages-content">
                    <div id="message-display" style="color: #00ff00;">
                        {% if state == 'start' %}
                            Ready for character creation...
                        {% elif state == 'in_progress' %}
                            {% if character.characteristics and 'str' in character.characteristics and 'dex' in character.characteristics and 'end' in character.characteristics and 'int' in character.characteristics and 'edu' in character.characteristics and 'soc' in character.characteristics %}
                            All characteristics rolled! Ready for service selection.
                            {% else %}
                            Roll each characteristic one by one using the buttons in the sidebar.
                            {% endif %}
                        {% elif state == 'complete' %}
                            Character generation complete!
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Interface loaded with state: {{ state }}");
            
            // Create Character Function - only if button exists
            const createBtn = document.getElementById('create-btn');
            if (createBtn) {
                createBtn.onclick = async function() {
                    console.log("Create button clicked!");
                    
                    this.disabled = true;
                    this.innerHTML = '<div style="font-size: 18px;">Creating...</div><div style="font-size: 12px; margin-top: 8px;">Generating character...</div>';
                    
                    const messageDisplay = document.getElementById('message-display');
                    messageDisplay.innerHTML = '> Creating character with random sci-fi name...';
                    
                    try {
                        const response = await fetch('/api/character/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || `HTTP ${response.status}`);
                        }
                        
                        const character = await response.json();
                        console.log("Character created:", character);
                        
                        messageDisplay.innerHTML = `> Created character: ${character.name}<br>> Age: ${character.age}<br>> Character locked in session<br>> Reloading interface...`;
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                        
                    } catch (error) {
                        console.error("Error creating character:", error);
                        messageDisplay.innerHTML = `> Error: ${error.message}`;
                        
                        this.disabled = false;
                        this.innerHTML = '<div style="font-size: 18px;">CREATE CHARACTER</div><div style="font-size: 12px; margin-top: 8px;">Generate random sci-fi name + characteristics</div>';
                    }
                };
            }
            
            // Characteristic Roll Button Function - for all roll buttons
            const rollButtons = document.querySelectorAll('.btn-roll');
            rollButtons.forEach(button => {
                button.onclick = async function() {
                    const characteristic = this.getAttribute('data-char');
                    console.log(`Roll ${characteristic} button clicked!`);
                    
                    this.disabled = true;
                    this.innerHTML = `<div style="font-size: 16px;">Rolling...</div>`;
                    
                    const messageDisplay = document.getElementById('message-display');
                    messageDisplay.innerHTML = `> Rolling for ${characteristic.toUpperCase()}...`;
                    
                    try {
                        const response = await fetch('/api/character/roll_characteristic', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ characteristic: characteristic })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || `HTTP ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log(`${characteristic} rolled:`, result);
                        
                        // Update the UI to display the rolled characteristic
                        const charElement = document.getElementById(`char-item-${characteristic}`);
                        if (charElement) {
                            // Remove the 'empty' class if it exists
                            charElement.classList.remove('empty');
                            
                            // Add a highlight class to draw attention
                            charElement.classList.add('highlight');
                            
                            // Update the characteristic value and hex display
                            charElement.innerHTML = `
                                <div class="char-label">${characteristic.toUpperCase()}</div>
                                <div class="char-value">${result.value}</div>
                                <div class="char-hex">(${result.hex_value})</div>
                            `;
                            
                            // Remove the highlight after 2 seconds
                            setTimeout(() => {
                                charElement.classList.remove('highlight');
                            }, 2000);
                        }
                        
                        messageDisplay.innerHTML = `> Rolled ${result.value} for ${characteristic.toUpperCase()}`;
                        
                        // Hide the button (will disappear on reload, but this provides immediate feedback)
                        this.style.display = 'none';
                        
                        // Check if all characteristics are rolled
                        const allRolled = checkAllCharacteristicsRolled(result.character);
                        if (allRolled) {
                            messageDisplay.innerHTML += '<br>> All characteristics rolled! Ready for service selection.';
                        }
                        
                        // Optional: Reload the page to update the UI fully
                        // setTimeout(() => {
                        //     window.location.reload();
                        // }, 1500);
                        
                    } catch (error) {
                        console.error(`Error rolling ${characteristic}:`, error);
                        messageDisplay.innerHTML = `> Error: ${error.message}`;
                        
                        this.disabled = false;
                        this.innerHTML = `
                            <div style="font-size: 16px;">${characteristic.toUpperCase()}</div>
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Roll 2d6</div>
                        `;
                    }
                };
            });
            
            // Helper function to check if all characteristics are rolled
            function checkAllCharacteristicsRolled(character) {
                if (!character || !character.characteristics) return false;
                
                const required = ['str', 'dex', 'end', 'int', 'edu', 'soc'];
                return required.every(stat => stat in character.characteristics);
            }
            
            // Delete Character Function - only if button exists
            const deleteBtn = document.getElementById('delete-btn');
            if (deleteBtn) {
                deleteBtn.onclick = async function() {
                    console.log("Delete button clicked!");
                    
                    this.disabled = true;
                    this.innerHTML = '<div style="font-size: 18px;">Deleting...</div>';
                    
                    const messageDisplay = document.getElementById('message-display');
                    messageDisplay.innerHTML = '> Deleting character and resetting session...';
                    
                    try {
                        const response = await fetch('/api/character/delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        console.log("Delete response:", response);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error("Server error:", errorText);
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        // Parse response as JSON
                        const result = await response.json();
                        console.log("Delete result:", result);
                        
                        if (result.success) {
                            messageDisplay.innerHTML = '> Character deleted. Session reset to start state.';
                            
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            throw new Error(result.message || "Unknown error during character deletion");
                        }
                        
                    } catch (error) {
                        console.error("Error deleting character:", error);
                        messageDisplay.innerHTML = `> Error: ${error.message}`;
                        
                        this.disabled = false;
                        this.innerHTML = '<div style="font-size: 18px;">DELETE CHARACTER</div><div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Reset and start over</div>';
                    }
                };
            }
        });
    </script>
</body>
</html>